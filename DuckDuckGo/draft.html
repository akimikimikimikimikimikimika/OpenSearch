<!doctype html>
<html>
	<head>

		<meta charset="UTF-8" />
		<title>DuckDuckGo</title>

		<meta name="referrer" content="no-referrer" />
		<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,minimum-scale=1.0,user-scalable=no,viewport-fit=cover" />
		<meta name="format-detection" content="telephone=no" />

		<meta name="apple-mobile-web-app-title" content="DuckDuckGo" />
		<link rel="shortcut icon" href="../Resources/search.png" />

		<link rel="search" type="application/opensearchdescription+xml" title="DuckDuckGo" href="opensearch/duckduckgo.xml" />
		<link rel="search" type="application/opensearchdescription+xml" title="DuckDuckGo (Onion)" href="opensearch/duckduckgo-onion.xml" />

		<link rel="stylesheet" href="../Resources/main.css" />
		<link rel="stylesheet" href="../Resources/default.css" />
		<style></style>
	</head>
	<body>
		<div id="base">
			<div id="header">
				<div>
					<form action="https://start.duckduckgo.com/html/" method="POST">
						<input type="text" role="searchbox" placeholder="DuckDuckGo" name="q" autofocus="autofocus" />
						<input type="hidden" name="kad" value="ja_JP" /><!-- DuckDuckGo language -->
						<input type="hidden" name="kl" value="jp-jp" /><!-- Search region -->
						<span id="params"></span>
						<span id="mode"></span>
					</form>
					<a id="icon" style="--image:url(../Resources/search.png);" href="https://start.duckduckgo.com/html/"></a>
				</div>
			</div>
			<noscript><div id="message"><div>Type keywords above and press return key</div></div></noscript>
		</div>
		<script>
			(()=>{

				let online=(()=>{
					let p=location.protocol;
					return /https/.test(p)||(/http/.test(p)&&location.hostname=="localhost");
				})();
				if (online) try{
					["../../Library/ServiceWorker.js","../Resources/ServiceWorker.js","ServiceWorker.js"].forEach(f=>navigator.serviceWorker.register(f).then(r=>r.update()));
				}catch(e){}

				/* dom function abbreviation */
				let qs=(q,t=document.body)=>t.querySelector(q),
				ce=(html)=>{
					let d=document.createElement("div");
					d.innerHTML=html;
					let e=d.firstChild;
					d.removeChild(e);
					return e;
				};

				/* element */
				let q=qs('[name="q"]'),
				f=qs("form"), /* form */
				a=qs("a"), /* icon */
				params=qs("#params") /* param list */,
				pm=qs("#mode"),
				cs=qs("style",document.head);

				/* icon works as a submit button */
				a.addEventListener("click",e=>{
					if (q.value=="") {
						f.removeChild(q);
						f.removeChild(pm);
						f.method="GET";
						setTimeout(()=>{
							f.appendChild(q);
							f.appendChild(pm);
							f.method=post?"POST":"GET";
						},0);
					}
					f.submit();
					e.preventDefault();
				});

				/* list constructor */
				let construct=(data,focus)=>{
					let o={
						data:data,
						node:ce(`<div class="list" />`),
						current:0,
					};
					let p=new Proxy(o,{
						set:(t,p,n)=>{
							if (p=="current") {
								o.current=n;
								didStateChange();
								data.forEach((d,m)=>d.node.classList.toggle("selected",n==m));
							}
						}
					});
					data.forEach((d,n)=>{
						let cell=ce(`<div><div>${d.name}</div></div>`);
						if (n==0) cell.classList.toggle("selected");
						cell.style.setProperty("--char",d.char?`"${d.char}"`:'" "');
						cell.style.setProperty("--image",d.image?`url(${d.image})`:"");
						cell.addEventListener("click",()=>{p.current=n;if (focus) q.focus();});
						d.node=cell;
						o.node.append(cell);
					});
					return p;
				};

				/* parameter data */
				let pd={
					// Reference: https://duckduckgo.com/params
					// On: 1, Off: -1
					"ia" :"web",   // search target
					"iax":"",
					"iar":"",
					"iaxm":"",
						// ia=web | ia,iax=images | ia,iax=videos | iar,ia=news | iaxm=maps

					"kad":"ja_JP", // search region
					"kl" :"jp-jp", // DuckDuckGo language
					"kp" :"-1",    // Safe search (1:On, -1:Moderate, -2:Off)
					"kz" : "1",    // Instant answer
					"kac": "1",    // Auto suggest
					"kc" : "1",    // Auto-load images
					"kav":"-1",    // Auto-load results
					"kn" :"-1",    // Open in new window
					"kaf":"-1",    // Full URLs
					"kh" : "1",    // SSL
					"k5" : "2",    // Video playback (1:play on DDG, 2:open on 3rd party site)
					"kg" : "p",    // g:GET p:POST
					"ks" : "n",    // Font Size (small s,m,n,l,t large)
					"kw" : "s",    // Width (normal n,w,s wide)
					"km" : "m",    // Placement (l:left, m:middle)
					"ku" :"-1",    // Underline
					"ka" : "n",    // Link font
					"kt" : "n",    // Font
					"ko" : "s",    // Header (1:scrolling, s:floating, -1:off expect instant answer, -2:off)
					"k1" : "1",    // Advertise
					"kv" : "1",    // Page number
					"kaj": "m",    // Measure units (m:Metric, u:US)
					"kam":"apple-maps", // Direction source (apple-maps,google-maps,bing-maps,osm,here)

					// Color
					"kae":"-1", // Theme = --theme
					"k7" :"", // Background = --background
					"kj" :"", // Header = --header
					"k8" :"", // Text = --text
					"kx" :"", // URL = --url
					"k9" :"", // Links = --link
					"kaa":""  // Visited Links = --visited-link
				};
				for (k in pd) {
					pd[k]=ce(`<input type="hidden" name="${k}" value="${pd[k]}" />`);
					if (!/^ia/.test(k)) params.append(pd[k]);
				}

				/* toggle a certain parameter */
				let tp=(p,b,l=params)=>{
					if (p.parentNode&&(!b)) l.removeChild(p);
					if ((!p.parentNode)&&b) l.appendChild(p);
					if (typeof(b)=="string") p.value=b;
					return p;
				};

				/* called when the state changed */
				let didStateChange=()=>{
					let sd=search.data[search.current];
					let dd=domains.data[domains.current];
					let td=themes.data[themes.current];

					cs.textContent=typeof(td.color)=="number"?sl[td.color]:"";

					let u=new URL(`https://${dd.domain}/`);
					if (post) {
						let p=u.searchParams;
						if (sd.ia)   p.set("ia",  sd.ia);
						if (sd.iax)  p.set("iax", sd.iax);
						if (sd.iar)  p.set("iar", sd.iar);
						if (sd.iaxm) p.set("iaxm",sd.iaxm);
					}
					tp(pd.ia,  post?0:sd.ia,  pm);
					tp(pd.iax, post?0:sd.iax, pm);
					tp(pd.iar, post?0:sd.iar, pm);
					tp(pd.iaxm,post?0:sd.iaxm,pm);
					f.action=u;
					f.method=post?"POST":"GET";

					if (sd.bang) f.onsubmit=()=>{
						let c=q.value;
						if (!c.match("!"+sd.bang)) {
							q.value=`!${sd.bang} ${c}`;
							setTimeout(()=>q.value=c,0);
						}
					};
					else f.onsubmit=null;

					let nc=td.noCustomize,s=window.getComputedStyle(document.documentElement);
					tp(pd.kae,     s.getPropertyValue("--theme"));
					tp(pd.k7, nc?0:s.getPropertyValue("--background"));
					tp(pd.kj, nc?0:s.getPropertyValue("--header"));
					tp(pd.k8, nc?0:s.getPropertyValue("--text"));
					tp(pd.kx, nc?0:s.getPropertyValue("--url"));
					tp(pd.k9, nc?0:s.getPropertyValue("--link"));
					tp(pd.kaa,nc?0:s.getPropertyValue("--visited-link"));

					tp(params,!td.noParams,f);
				};

				window.matchMedia("(prefers-color-scheme:light)").addListener(m=>didStateChange());
				window.matchMedia("(prefers-color-scheme:dark)").addListener(m=>didStateChange());

				/* h:int(0~17) s,l,a:float(0~1) */
				let hsl2rgb=(()=>{
					let p="300,310,320,330,230,130,030,031,032,033,023,013,003,103,203,303,302,301".split(",").map(t=>t.split("").map(s=>parseInt(s)));
					return (h,s,l,a)=>{
						let min=Math.max(l*2-1,0),max=Math.min(l*2,1);
						let lo=((1+s)*min+(1-s)*max)/2,up=((1-s)*min+(1+s)*max)/2;
						let rgb=p[h].map(v=>Math.round((v/3*(up-lo)+lo)*255));
						if (a) return `rgba(${rgb.join(",")},${a})`;
						else return `#${rgb.map(v=>{
							let t=v.toString(16);
							if (t.length==1) t="0"+t;
							return t;
						}).join("")}`;
					};
				})();
				let il=[...Array(19).keys()].map(n=>"data:image/svg+xml;base64,"+btoa(`
					<svg xmlns="http://www.w3.org/2000/svg" viewBox="-8 -8 16 16">
						<circle cx="0" cy="0" r="7" fill="${hsl2rgb(n%18,n==18?0:1,.5)}" />
					</svg>
				`));
				let sl=[...Array(18).keys()].map(n=>`
					@media (prefers-color-scheme:light) {
						:root{
							--foreground:${hsl2rgb(n,.8,.2)};
							--background:${hsl2rgb(n,.8,.9)};
							--header:${hsl2rgb(n,.8,.8)};
							--bg-transparent:${hsl2rgb(n,.8,.933,.75)};
							--search-field:${hsl2rgb(n,.8,.8,.5)};
							--placeholder:${hsl2rgb(n,.8,.2,.6)};
							--selection:${hsl2rgb(n,.8,.4,.4)};
							--caret:${hsl2rgb(n,.8,.4)};
							--button-border:${hsl2rgb(n,.8,.4)};
							--button-selected:${hsl2rgb(n,.8,.8)};
							--list-item:${hsl2rgb(n,.8,.7,.6)};
							--list-item-selected:${hsl2rgb(n,.8,.3,.6)};
							--message:${hsl2rgb(n,.8,.4)};
							--text:${hsl2rgb(n,.8,.2)};
							--url:${hsl2rgb(n,.8,.2)};
							--link:${hsl2rgb(n,.8,.4)};
							--visited-link:${hsl2rgb(n,.8,.6)};
							--theme:-1;
						}
					}
					@media (prefers-color-scheme:dark) {
						:root{
							--foreground:${hsl2rgb(n,.8,.9)};
							--background:${hsl2rgb(n,.8,.1)};
							--header:${hsl2rgb(n,.8,.4)};
							--bg-transparent:${hsl2rgb(n,.8,.2,.75)};
							--search-field:${hsl2rgb(n,.8,.4,.5)};
							--placeholder:${hsl2rgb(n,.8,.9,.6)};
							--selection:${hsl2rgb(n,.8,.6,.4)};
							--caret:${hsl2rgb(n,.8,.8,.8)};
							--button-border:${hsl2rgb(n,.8,.6)};
							--button-selected:${hsl2rgb(n,.6,.4)};
							--list-item:${hsl2rgb(n,.8,.4,.6)};
							--list-item-selected:${hsl2rgb(n,.8,.6,.6)};
							--message:${hsl2rgb(n,.8,.6)};
							--text:${hsl2rgb(n,.8,.933)};
							--url:${hsl2rgb(n,.8,.933)};
							--link:${hsl2rgb(n,.8,.8)};
							--visited-link:${hsl2rgb(n,.8,.6)};
							--theme:d;
						}
					}
				`);

				/* search data */
				let search=construct([
					{
						name:"Web",
						ia:"web"
					},
					{
						name:"ducky",
						ia:"web",
						bang:"ducky"
					},
					{
						name:"Maps",
						iaxm:"maps"
					},
					{
						name:"Images",
						ia:"images",
						iax:"images"
					},
					{
						name:"Videos",
						ia:"videos",
						iax:"videos"
					},
					{
						name:"News",
						ia:"news",
						iar:"news"
					},
					{
						name:"Bang search",
						ia:"web",
						bang:"bang"
					}
				].map(d=>{
					d.image="../Resources/search.png";
					return d;
				}),true);
				document.body.append(search.node);

				/* domain data */
				let domains=construct([
					{
						name:"DuckDuckGo",
						char:"D",
						domain:"start.duckduckgo.com"
					},
					{
						name:"Normal DDG",
						char:"D",
						domain:"www.duckduckgo.com"
					},
					{
						name:"Onion DDG",
						char:"ðŸ§…",
						domain:"3g2upl4pq6kufc4m.onion"
					},
				]);
				domains.node.classList.toggle("hidden",true);
				document.body.append(domains.node);

				let themes=construct([
					{
						name:"No params",
						noParams:true,
						noCustomize:true
					},
					{
						name:"Normal",
						noCustomize:true
					},
					{
						name:"S"
					},
					...[...Array(18).keys()].map(n=>({
						name:(n+10).toString(36).toUpperCase(),
						image:il[n],
						color:n
					}))
				].map(o=>{
					if (!o.image) o.image=il[18];
					return o;
				}));
				themes.node.classList.toggle("hidden",true);
				document.body.append(themes.node);

				var post=true;

				document.documentElement.classList.toggle("hide-bar",false);
				let bb=qs("#header>div").appendChild(ce(`<div id="bottomBar"><div class="selected">Search for</div><div>Domains</div><div>Themes</div><div>POST</div></div>`));
				let setBB=n=>{
					if (n==3) {
						let m=f.method.toLowerCase();
						switch (m) {
							case "get": m="POST"; break;
							case "post": m="GET"; break;
							default: m="GET";
						}
						post=m=="POST";
						bb.lastChild.textContent=m;
						didStateChange();
					}
					else {
						bb.childNodes.forEach((b,m)=>b.classList.toggle("selected",n==m));
						[search,domains,themes].forEach((o,m)=>o.node.classList.toggle("hidden",n!=m));
					}
				};
				bb.childNodes.forEach((b,n)=>b.addEventListener("click",e=>{setBB(n);e.preventDefault();}));

				themes.current=2;
				window.addEventListener("load",()=>q.focus());

			})();
		</script>
	</body>
</html>
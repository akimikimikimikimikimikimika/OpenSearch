<!doctype html>
<html class="hide-bar" xmlns="http://www.w3.org/1999/xhtml" lang="ja-JP" xml:lang="ja-JP">
	<head>

		<meta charset="UTF-8" />
		<title>StartPage</title>

		<meta name="referrer" content="no-referrer" />
		<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,minimum-scale=1.0,user-scalable=no,viewport-fit=cover" />
		<meta name="format-detection" content="telephone=no" />

		<meta name="apple-mobile-web-app-title" content="StartPage" />
		<link rel="shortcut icon" href="../Resources/search.png" />

		<link rel="search" type="application/opensearchdescription+xml" title="Qwant" href="opensearch.xml" />

		<link rel="stylesheet" href="../Resources/main.css" />
		<link rel="stylesheet" href="../Resources/default.css" />
	</head>
	<body>
		<div id="base">
			<div id="header">
				<div>
					<form action="https://www.startpage.com/do/search" method="POST">
						<input type="text" role="searchbox" placeholder="StartPage" name="query" autofocus="autofocus" />
						<span id="params"></span>
					</form>
					<a id="icon" style="--image:url(../Resources/search.png);" href="https://www.startpage.com"></a>
				</div>
			</div>
			<noscript><div id="message"><div>Type keywords above and press return key</div></div></noscript>
		</div>
		<script>
			(()=>{

				/* dom function abbreviation */
				let qs=(q,t=document.body)=>t.querySelector(q),
				ce=(html)=>{
					let d=document.createElement("div");
					d.innerHTML=html;
					let e=d.firstChild;
					d.removeChild(e);
					return e;
				};

				/* element */
				let html=document.documentElement,
				q=qs('[name="query"]'),
				pl=qs("#params"), /* params */
				f=qs("form"), /* form */
				a=qs("a"), /* icon */
				base=qs("#base");

				/* icon works as a submit button */
				a.addEventListener("click",e=>{
					if (q.value=="") {
						let u=f.action;
						f.action=a.href;
						setTimeout(()=>f.action=u,0);
					}
					f.submit();e.preventDefault();
				});

				/* list constructor */
				let construct=(data)=>{
					let o={
						data:data,
						node:ce(`<div class="list" />`),
						current:0,
					};
					let p=new Proxy(o,{
						set:(t,p,n)=>{
							if (p=="current") {
								o.current=n;
								didStateChange();
								data.forEach((d,m)=>d.node.classList.toggle("selected",n==m));
							}
						}
					});
					data.forEach((d,n)=>{
						let cell=ce(`<div><div>${d.name}</div></div>`);
						if (n==0) cell.classList.toggle("selected");
						cell.style.setProperty("--char",d.char?`"${d.char}"`:'" "');
						cell.style.setProperty("--image",d.image?`url(${d.image})`:"");
						cell.addEventListener("click",()=>{p.current=n;q.focus();});
						d.node=cell;
						o.node.append(cell);
					});
					return p;
				};

				/* parameter data */
				let pd={
					"cat"     :"web",     // search for
					"language":"nihongo", // search result language
					"lui"     :"english", // interface language
					"t"       :"dark"     // appearance
				};
				for (k in pd) {
					pd[k]=ce(`<input type="hidden" name="${k}" value="${pd[k]}" />`);
					if (!/^ia/.test(k)) params.append(pd[k]);
				}

				/* toggle a certain parameter */
				let tp=(p,b)=>{
					if (p.parentNode&&(!b)) pl.removeChild(p);
					if ((!p.parentNode)&&b) pl.appendChild(p);
					if (typeof(b)=="string") p.value=b;
					return p;
				};

				let didStateChange=()=>{
					let d=search.data[search.current];
					tp(pd.cat,d.cat);
					let bc=window.getComputedStyle(html).getPropertyValue("--base-color");
					switch (bc) {
						case "#333333": tp(pd.t,"dark"); break;
						case "#ffffff": tp(pd.t,"dawn"); break;
						default:        tp(pd.t,"default");
					}
				};

				window.matchMedia("(prefers-color-scheme:light)").addListener(m=>{didStateChange()});
				window.matchMedia("(prefers-color-scheme:dark)").addListener(m=>{didStateChange()});

				/* search data */
				let search=construct([
					{
						name:"Web",
						cat:"web"
					},
					{
						name:"Images",
						cat:"pics"
					},
					{
						name:"Videos",
						cat:"video"
					},
					{
						name:"News",
						cat:"news"
					}
				].map(d=>{
					d.image="../Resources/search.png";
					return d;
				}));
				base.append(search.node);

				html.classList.toggle("hide-bar",false);
				let bb=qs("#header>div").appendChild(ce(`<div id="bottomBar"><div>POST</div></div>`));
				let setBB=()=>{
					let m=f.method.toLowerCase();
					switch (m) {
						case "get": m="POST"; break;
						case "post": m="GET"; break;
						default: m="GET";
					}
					f.method=m;
					bb.lastChild.textContent=m;
				};
				bb.lastChild.addEventListener("click",e=>{setBB();e.preventDefault();});

				window.addEventListener("load",()=>q.focus());

			})();
		</script>
	</body>
</html>